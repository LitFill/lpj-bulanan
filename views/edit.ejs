<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit LPJ Bulanan</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-12 px-2 md:px-0">
    <div class="max-w-3xl mx-auto mt-4 md:mt-10 bg-white p-4 md:p-8 rounded-xl shadow-lg border border-gray-100">
        <div class="text-center mb-6 md:mb-10">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Edit LPJ Bulanan</h1>
            <p class="text-sm md:text-base text-gray-500 mt-2">Perbarui data laporan pertanggungjawaban</p>
            <div class="mt-4 flex flex-wrap justify-center gap-2 md:gap-4 text-xs md:text-sm">
                <a href="/reports" class="text-blue-600 hover:text-blue-800 font-semibold underline decoration-2 underline-offset-4 transition">
                    &larr; Kembali ke Arsip
                </a>
            </div>
        </div>

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 mb-6 text-sm rounded-r-lg" role="alert">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="font-bold">Gagal Memperbarui Laporan:</span>
                </div>
                <p class="mt-1 ml-7"><%= error %></p>
            </div>
        <% } %>

        <form action="/update-report/<%= report.id %>" method="POST" enctype="multipart/form-data" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Pelapor</label>
                    <input type="text" name="nama" required placeholder="Nama lengkap" value="<%= report.nama_pelapor %>" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Divisi/Departemen</label>
                    <% 
                        const asramas = ["Koordinator Asrama Deza", "Koordinator Asrama Nahwu", "Koordinator Asrama Hadits", "Koordinator Asrama Fiqih", "Koordinator Asrama Selatan", "Koordinator Asrama Pdf"];
                        const isAsrama = asramas.includes(report.divisi);
                        const displayDivisi = isAsrama ? "Ko'or Asrama" : report.divisi;
                    %>
                    <select name="divisi" id="divisi-select" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <% const divisis = ["Sekretaris", "Bendahara", "Kema'arifan Pusat", "Kema'arifan Bidang Bahasa", "Kema'arifan Bidang Tahfidz", "Mudzakaroh", "Keamanan", "Kebersihan", "Kesehatan", "Media", "Sarpras", "Penerangan", "Sound", "Pengairan", "Humas", "EO", "Ko'or Asrama", "Pembimbing Kamar", "Pendidikan (Madin)"]; %>
                        <% divisis.forEach(div => { %>
                            <option <%= displayDivisi === div ? 'selected' : '' %>><%= div %></option>
                        <% }); %>
                    </select>
                </div>
            </div>

            <!-- Selection for Koordinator Asrama -->
            <div id="asrama-selection" class="<%= isAsrama ? '' : 'hidden' %>">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Asrama</label>
                <select name="nama_asrama" id="asrama-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                    <option value="" disabled <%= !isAsrama ? 'selected' : '' %>>-- Pilih Nama Asrama --</option>
                    <% asramas.forEach(asrama => { %>
                        <option <%= report.divisi === asrama ? 'selected' : '' %>><%= asrama %></option>
                    <% }); %>
                </select>
            </div>

            <!-- Warning for Pembimbing Kamar -->
            <div id="dev-warning" class="<%= report.divisi === 'Pembimbing Kamar' ? '' : 'hidden' %> bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700 font-medium">
                            Maaf, bagian <span class="font-bold">Pembimbing Kamar</span> masih dalam tahap pembangunan dan belum bisa diisi.
                        </p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Bulan Laporan</label>
                    <input type="month" name="bulan" id="bulan-input" required value="<%= report.bulan %>" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Lampiran Tambahan (Kosongkan jika tidak ingin ganti)</label>
                    <input type="file" name="attachment" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <% if (report.attachment_filename) { %>
                        <p class="text-xs text-gray-500 mt-1">File saat ini: <%= report.attachment_filename %></p>
                    <% } %>
                </div>
            </div>

            <hr class="border-gray-100">

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Realisasi Program Kerja</label>
                <textarea name="program_kerja" rows="4" required placeholder="Detail kegiatan yang telah dilaksanakan..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"><%= report.program_kerja %></textarea>
            </div>

            <!-- Rincian Pemasukan -->
            <!-- Note: Simplified for edit, in real app we might need to parse JSON if stored as such, but here we'll assume we can't easily parse without helper. For now let's just use the totals or ask user if they need full detail edit.
                 Looking at server.js, the details aren't stored in DB as JSON, only totals. 
                 Wait, if I want to re-generate PDF, I need the details. 
                 The current DB schema only has 'pemasukan' and 'pengeluaran' as totals. 
                 It seems the details are ONLY in the PDF. That's a limitation.
            -->
            <p class="text-xs text-yellow-600 bg-yellow-50 p-2 rounded">Note: Rincian item saat ini hanya bisa diperbarui totalnya karena data item tidak disimpan di database.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Total Pemasukan (Rp)</label>
                    <input type="number" name="pemasukan" value="<%= report.pemasukan %>" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Total Pengeluaran (Rp)</label>
                    <input type="number" name="pengeluaran" value="<%= report.pengeluaran %>" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Evaluasi & Kendala</label>
                <textarea name="evaluasi" rows="3" required placeholder="Apa hambatan bulan ini?" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"><%= report.evaluasi %></textarea>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Rencana Bulan Depan</label>
                <textarea name="rencana" rows="3" required placeholder="Target atau agenda bulan depan..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"><%= report.rencana %></textarea>
            </div>

            <button type="submit" id="submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-xl shadow-lg hover:shadow-xl transition transform active:scale-[0.98] text-lg flex justify-center items-center gap-2">
                <span id="btn-text">Update Laporan & Regenerate PDF</span>
                <svg id="btn-spinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </form>
    </div>

    <script>
        // Form Loading State
        document.querySelector('form').addEventListener('submit', function(e) {
            const btn = document.getElementById('submit-btn');
            const text = document.getElementById('btn-text');
            const spinner = document.getElementById('btn-spinner');

            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');
            text.innerText = 'Sedang Memperbarui...';
            spinner.classList.remove('hidden');
        });

        // Divisi restriction logic
        const divisiSelect = document.getElementById('divisi-select');
        const asramaSelection = document.getElementById('asrama-selection');
        const asramaSelect = document.getElementById('asrama-select');
        const devWarning = document.getElementById('dev-warning');
        const submitBtn = document.getElementById('submit-btn');

        function updateDivisiStatus() {
            if (divisiSelect.value === 'Pembimbing Kamar') {
                devWarning.classList.remove('hidden');
                asramaSelection.classList.add('hidden');
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                asramaSelect.required = false;
            } else if (divisiSelect.value === "Ko'or Asrama") {
                devWarning.classList.add('hidden');
                asramaSelection.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                asramaSelect.required = true;
            } else {
                devWarning.classList.add('hidden');
                asramaSelection.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                asramaSelect.required = false;
            }
        }

        divisiSelect.addEventListener('change', updateDivisiStatus);
        
        // Initial check on load
        updateDivisiStatus();
    </script>
</body>
</html>
