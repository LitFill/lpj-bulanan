    <script>
        // Safety Cushion: Prevent Unsaved Changes
        let isFormDirty = false;
        
        function markDirty() {
            isFormDirty = true;
        }

        window.onbeforeunload = function() {
            if (isFormDirty) {
                return "Anda memiliki perubahan yang belum disimpan. Yakin ingin keluar?";
            }
        };

        // Form Loading State & Reset Dirty Flag
        document.querySelector('form').addEventListener('submit', function(e) {
            isFormDirty = false;
            const btn = document.getElementById('submit-btn');
            const text = document.getElementById('btn-text');
            const spinner = document.getElementById('btn-spinner');
            
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');
            text.innerText = 'Sedang Memproses...';
            spinner.classList.remove('hidden');
        });

        function addRow(containerId) {
            const container = document.getElementById(containerId);
            const isPemasukan = containerId === 'pemasukan-list';
            const focusColor = isPemasukan ? 'blue' : 'red';
            const div = document.createElement('div');
            div.className = 'flex flex-col md:grid md:grid-cols-12 gap-2 item-row p-3 md:p-0 bg-gray-50 md:bg-transparent rounded-lg md:rounded-none relative';
            div.innerHTML = `
                <input type="text" name="${isPemasukan ? 'pemasukan_ket[]' : 'pengeluaran_ket[]'}" placeholder="Keterangan" oninput="handleAutoRow(this, '${containerId}'); markDirty()" class="col-span-7 px-3 py-2 border rounded-lg text-sm outline-none focus:ring-1 focus:ring-${focusColor}-500">
                <div class="col-span-4 flex items-center gap-2">
                    <span class="text-xs font-bold text-gray-400 md:hidden">Rp</span>
                    <input type="number" name="${isPemasukan ? 'pemasukan_val[]' : 'pengeluaran_val[]'}" value="0" oninput="handleAutoRow(this, '${containerId}'); calculateTotals(); markDirty()" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-1 focus:ring-${focusColor}-500">
                </div>
                <button type="button" onclick="this.parentElement.remove(); calculateTotals(); markDirty()" class="absolute top-2 right-2 md:static md:col-span-1 text-red-400 hover:text-red-600 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            container.appendChild(div);
        }

        function handleAutoRow(input, containerId) {
            const container = document.getElementById(containerId);
            const rows = container.querySelectorAll('.item-row');
            const lastRow = rows[rows.length - 1];
            
            if (input.parentElement.parentElement === lastRow && input.value.trim() !== "" && input.value !== "0") {
                addRow(containerId);
            }
        }

        function calculateTotals() {
            let totalMasuk = 0;
            let totalKeluar = 0;
            
            document.querySelectorAll('input[name="pemasukan_val[]"]').forEach(input => {
                totalMasuk += Number(input.value || 0);
            });
            
            document.querySelectorAll('input[name="pengeluaran_val[]"]').forEach(input => {
                totalKeluar += Number(input.value || 0);
            });
            
            const saldo = totalMasuk - totalKeluar;
            document.getElementById('total-pemasukan').value = totalMasuk;
            document.getElementById('total-pengeluaran').value = totalKeluar;
            document.getElementById('total-saldo').value = saldo;

            // Safety Cushion: Negative Balance Warning
            const saldoWarning = document.getElementById('saldo-warning');
            const saldoInput = document.getElementById('total-saldo');
            if (saldo < 0) {
                saldoWarning.classList.remove('hidden');
                saldoInput.classList.replace('text-green-600', 'text-red-600');
            } else {
                saldoWarning.classList.add('hidden');
                saldoInput.classList.replace('text-red-600', 'text-green-600');
            }
        }

        // Initialize auto-row and safety limits
        window.addEventListener('DOMContentLoaded', () => {
            // Set max month to current
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('bulan-input').setAttribute('max', `${year}-${month}`);

            // Divisi restriction logic
            const divisiSelect = document.getElementById('divisi-select');
            const devWarning = document.getElementById('dev-warning');
            const submitBtn = document.getElementById('submit-btn');

            divisiSelect.addEventListener('change', function() {
                markDirty();
                if (this.value === 'Pembimbing Kamar') {
                    devWarning.classList.remove('hidden');
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    devWarning.classList.add('hidden');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });

            document.querySelectorAll('input, textarea').forEach(input => {
                input.addEventListener('change', markDirty);
            });

            document.querySelectorAll('.item-row input').forEach(input => {
                const containerId = input.closest('[id$="-list"]').id;
                input.addEventListener('input', function() {
                    handleAutoRow(this, containerId);
                    if (this.type === 'number') calculateTotals();
                });
            });
        });
    </script>
</body>
</html>
